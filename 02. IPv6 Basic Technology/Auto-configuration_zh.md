## 自动配置

IPv6的一个设计目标是可以在隔离网络中"开箱即用"（在20世纪90年代初被称为"牙医诊所"网络）。当然，今天从字面上来看，这是一个不太可能的场景，但同样，隔离的网络段确实会出现。对于这种场景，IPv6有一个优雅的解决方案：当IPv6节点首次检测到活动网络接口时，它会自动在该接口上配置一个链路本地地址，例如`fe80::a1b3:6d7a:3f65:dd13`。接口标识符是一个伪随机的64位数字，通常对于给定接口是固定的。（在遗留实现中，它可能从接口的IEEE MAC地址派生，但这种方法现在已被弃用。）

链路本地地址仅可用于同一链路上的操作。最常见的情况是主机与其第一跳路由器之间的流量。另一种可能的情况是主机与本地打印机之间的流量。没有什么可以阻止它们用于本地节点之间的任何其他类型的流量，但它们在给定链路*之外*是无用的，绝对不应该出现在DNS中。

更多细节在
[RFC 4862](https://www.rfc-editor.org/info/rfc4862)中给出。此外，我们跳过了一个重要问题，将在稍后讨论：重复地址检测。

当节点配置了链路本地地址后，它会继续一个称为SLAAC（发音为'slack'）的过程——无状态地址自动配置——以便配置至少一个可路由地址\[[RFC4862](https://www.rfc-editor.org/info/rfc4862)\]。自然，这只能在连接了IPv6路由器的链路上发生。如果没有这样的路由器，只能进行链路本地IPv6操作。因此，第一步是路由器发现。支持SLAAC的IPv6路由器**必须**侦听链路本地所有路由器多播地址，定义为`ff02::2`。新节点将向该地址发送路由器请求ICMPv6消息。每个SLAAC路由器将通过其链路本地地址向新节点响应路由器通告（RA）ICMPv6消息。（RA消息也定期发送到`ff02::1`，即链路本地所有节点多播地址。这对于刷新所有节点中的信息很重要。）

RA消息相当复杂，在
[RFC 4861](https://www.rfc-editor.org/info/rfc4861)中详细定义。它们为每个可处理的可路由IPv6前缀包含一个前缀信息选项（PIO）。PIO自然包含前缀本身（理论上任何长度；实际上通常是64位）、一些生命周期信息和两个称为L和A的标志位。L=1表示该前缀确实在相关链路上受支持——这是前一节中提到的链上确定所需的。A=1表示该前缀确实可用于无状态地址自动配置。A=L=0的PIO仅表示路由器可以充当相关前缀的第一跳路由器
\[[RFC8028](https://www.rfc-editor.org/info/rfc8028)\]。对于自动配置，当节点接收到A=L=1的典型RA/PIO时，它为自己配置一个地址，并记录所通告的前缀在链上的事实。例如，如果PIO中通告的前缀是`2001:db8:4006:80b::/64`，并且相关接口的预定义接口标识符是`a1b3:6d7a:3f65:dd13`，则节点将把接口的新地址配置为`2001:db8:4006:80b:a1b3:6d7a:3f65:dd13`。

如
[2. 地址](../02.%20IPv6%20Basic%20Technology/Addresses.md)中所述，接口标识符应该是伪随机的以增强隐私，除非是公共服务器的情况（因此某个大公司使用像`face:b00c:0:25de`这样的标识符）。出于实际原因，通常首选稳定标识符
\[[RFC8064](https://www.rfc-editor.org/info/rfc8064)\]，但临时标识符可以更好地保护隐私
\[[RFC8981](https://www.rfc-editor.org/info/rfc8981)\]。

配置链路本地地址或可路由地址的一个重要步骤是*重复地址检测*（DAD）。在新地址可以安全使用之前，节点首先发送此地址的邻居请求，如前一节所述。如果它收到邻居通告作为回复，则存在重复，必须放弃新地址。为DAD发送的邻居请求增加了上面提到的多播扩展问题。

这里值得强调IPv6的几个特性：

1. 同一物理链路上可以激活多个子网前缀。因此，主机可能接收到几个不同的PIO消息，并为每个接口配置多个可路由地址。此外，例如在使用临时地址
   \[[RFC8981](https://www.rfc-editor.org/info/rfc8981)\]时，主机可能在*同一前缀下*同时拥有多个地址。这不是错误；这是正常的IPv6行为。

1. GUA和ULA地址（参见
   [2. 地址](../02.%20IPv6%20Basic%20Technology/Addresses.md)）都是可路由的，尽管ULA仅在管理边界内可路由。同时拥有GUA和ULA也是正常的IPv6行为。

所有IPv6节点**必须**支持上述SLAAC，以防它们发现自己处于只有这种获取地址方法的网络上。但是，一些网络运营商更喜欢使用DHCPv6管理地址，如下一节所述。RA消息格式中有一个全局标志，称为M位（详见
[RFC 4861](https://www.rfc-editor.org/info/rfc4861)）。如果M=1，则DHCPv6用于地址分配。但是，仍然需要PIO来允许链上确定，并且仍然需要链路本地地址。

*更多细节*：本节和上一节总结了一个复杂的主题。除了基本规范
[RFC 4861](https://www.rfc-editor.org/info/rfc4861)和
[RFC 4862](https://www.rfc-editor.org/info/rfc4862)，关于这个主题还有许多其他RFC，例如：

- 增强重复地址检测，
  [RFC 7527](https://www.rfc-editor.org/info/rfc7527)

- IPv6子网模型：链路和子网前缀之间的关系，
  [RFC 5942](https://www.rfc-editor.org/info/rfc5942)

RA消息中允许的众多选项，以及用于地址解析和SLAAC的其他ICMPv6消息，在IANA的
[IPv6邻居发现选项格式注册表](https://www.iana.org/assignments/icmpv6-parameters/icmpv6-parameters.xhtml#icmpv6-parameters-5)中记录。

简单的网络可以将SLAAC作为配置主机IPv6连接的唯一方式来运行。DNS参数可以使用RA选项（递归DNS服务器选项和DNS搜索列表选项）进行配置
\[[RFC8106](https://www.rfc-editor.org/info/rfc8106)\]。

然而，如前一节所述，邻居发现和SLAAC对链路层多播的依赖性不能很好地扩展，特别是在无线网络上。此外，SLAAC为每个主机分配多个地址的能力，特别是动态临时地址
\[[RFC8981](https://www.rfc-editor.org/info/rfc8981)\]，可能会给路由器带来扩展问题。

当运营商偏好时，特别是对于大型网络，可以使用DHCPv6实现托管配置，如下一节所述。

<!-- Link lines generated automatically; do not delete -->

### [<ins>上一页</ins>](Address%20resolution.md) [<ins>下一页</ins>](Managed%20configuration.md) [<ins>顶部</ins>](02.%20IPv6%20Basic%20Technology.md)
