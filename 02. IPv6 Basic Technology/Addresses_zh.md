## 地址

128位地址足够大，假设采用明智的分配策略，IPv6将[永远](https://m.xkcd.com/865/)不会耗尽地址。然而，选择128位而不是64位的原因不仅仅如此：还为了允许地址具有一些内在结构，如下所述。另一方面，IPv6单播路由的*基本*属性是它
[基于所有128位](http://www.rfc-editor.org/info/bcp198)，
无论任何内部结构如何。换句话说，单播路由前缀的长度在1到128位之间。下面有更多关于[路由](Routing.md)的内容。

_术语说明_：在比较两个地址前缀时，_较长_前缀覆盖较小的地址空间（例如，52位前缀覆盖76位地址空间），_较短_前缀覆盖较大的地址空间（例如，48位前缀覆盖80位地址空间）。不幸的是，一些文档使用"较大前缀"这个术语，这是有歧义的。

IPv6地址空间的巨大数量允许在网络设计中拥有IPv4从未有过的大量自由度。这在\[[5. 网络设计](../05.%20Network%20Design/05.%20Network%20Design.md)\]中讨论。

IPv6地址架构由
[RFC 4291](http://www.rfc-editor.org/info/rfc4291)定义，自2006年以来没有进行过根本性修订，尽管有许多RFC对其进行了部分更新。

### 表示法

我们将首先介绍IPv6地址的表示法，然后使用该表示法解释主要特性。

写下128位地址的唯一可行方式是使用十六进制。毫无疑问，这不如IPv4使用的十进制表示法方便，但这是不可避免的。尽管您可能在较旧的RFC中看到不同的写法，
[RFC5952今天的建议](https://www.rfc-editor.org/info/rfc5952)
是对十六进制使用小写字母。因此，表示法的基本示例是：

```
2001:0db8:ef01:2345:6789:abcd:ef01:2345
```

在该示例中，有8组4位十六进制数字，以16位块的形式指定所有128位。在传统的十六进制表示法中，这将是`0x20010db8ef0123456789abcdef012345`。冒号（':'）用于帮助读者阅读。

在每个16位块中，前导零被省略，因此我们写：

```
2001:db8:ef01:45:6789:abcd:ef01:2345
```

**而不是**：

```
2001:0db8:ef01:0045:6789:abcd:ef01:2345
```

IPv6地址中通常有一连串的零字节。一个这样的连串可以用双冒号（'::'）替换，因此我们写：

```
2001:db8::6789:abcd:ef01:2345
```

**而不是**：

```
2001:db8:0:0:6789:abcd:ef01:2345
```

在几乎所有情况下，IPv6地址应该被复制粘贴。如果您确实需要手动输入，需要非常小心。请注意，并非所有实现都会严格遵循RFC9592，较旧的文档通常使用大写十六进制。

选择':'作为分隔符在一个特定方面令人烦恼——当冒号具有另一个含义并用作地址和端口之间的分隔符时。这在（Web）URL中非常常见，这就是为什么URL中的IPv6地址放在方括号中，如下所示：

```
https://[2001:db8:4006:80b::200e]:443
```

### 地址注册机构

顶级地址注册机构由IANA
（互联网号码分配机构）在
[IPv6地址空间注册表](https://www.iana.org/assignments/ipv6-address-space/ipv6-address-space.xhtml)
和从该页面链接的几个附属注册表中维护。

区域地址分配由RIR（区域互联网注册机构）维护，如[IANA网站](https://www.iana.org/numbers)上所述。RIR反过来将地址空间分配给互联网服务提供商、国家注册机构或本地注册机构。

### 简单地址

未指定的IPv6地址只是零，表示为`::`。

环回IPv6地址是1，表示为`::1`。请注意，IPv6只有一个环回地址，而IPv4为环回地址保留了`127.0.0.0/8`。似乎一些运营商误用了诸如`::2`或`::3`之类的地址，就好像它们是环回地址一样；这是一种错误配置。

### 可路由单播地址

这是最常见的情况。单播地址分为路由前缀后跟接口标识符（IID）。正常情况是64位前缀标识子网，后跟64位IID。因此：

```
 ----- prefix ----  IID
 |               |  |  |
 2001:db8:4006:80b::cafe
```

然而，这是一个不好的例子，因为'cafe'可能是可猜测的。出于隐私原因，
[强烈建议](https://www.rfc-editor.org/info/rfc8064)使用伪随机IID：

```
 ----- prefix ---- ------- IID -------
 |               | |                 |
 2001:db8:4006:80b:a1b3:6d7a:3f65:dd13
```

这取代了基于IEEE MAC地址形成IID的已弃用机制。许多遗留产品仍然使用该机制。

在此示例中，我们使用了基于`2001:db8::/32`前缀的64位前缀，该前缀保留供文档使用，但目前所有
[分配给区域互联网注册机构的前缀](https://www.iana.org/assignments/ipv6-unicast-address-assignments/ipv6-unicast-address-assignments.xhtml)
都以2开头。这些地址通常被称为GUA（全球可达唯一地址）。注册机构的前缀分配策略背景由
[BCP 157](https://www.rfc-editor.org/info/bcp157)涵盖。

（顺便说一句，`2001:db8::/32`是32位前缀的完整表示法，但有时非正式地写为`2001:db8/32`，让读者插入缺失的'::'。）

GUA通常被描述为在管理上属于两类之一，PI或PA。提供商独立（PI）地址前缀是那些由地址注册机构之一直接分配给最终用户站点的前缀。提供商分配（PA）地址前缀是那些由其互联网服务提供商之一分配给最终用户站点的前缀。即使站点更换到不同的服务提供商，PI前缀仍然有效；如果站点放弃相关ISP，PA前缀就会消失，并且一些ISP会不时更改站点的PA前缀而不发出警告。PA地址的好处是，给定ISP的所有客户前缀可以聚合到单个BGP-4通告中，从而大大减少互联网全球路由表的增长。相比之下，每个新的PI前缀都会增加到全球路由表中。因此，数百万站点使用PI前缀是不可接受的。

存在另一种类型的可路由单播地址，称为唯一本地地址（ULA）。其好处是：

1. 它们由特定网络为自己的内部使用自行分配。
1. 它们都在包含本地分配的*伪随机*40位部分的/48前缀下。
1. 它们**禁止**在开放互联网上路由，因此保持私有。

示例：

```
 ----- prefix --- ------- IID -------
 |              | |                 |
 fd63:45eb:dc14:1:a1b3:6d7a:3f65:dd13
```

'fd'前缀足以识别ULA。在此示例中，

- `fd63:45eb:dc14::/48`是所谓的ULA前缀。
- 本地生成的伪随机部分是`0x6345ebdc14`。
- `fd63:45eb:dc14:1::/64`是子网前缀。

偶尔人们使用前缀`fd00::/48`（零代替伪随机位），但不建议这样做。如果合并两个这样的网络，事情就会出问题。

稍微令人困惑的是，GUA和ULA在架构上都被定义为具有"全局作用域"，但ULA*按规则*禁止全局路由。

在前面的示例中，前缀边界显示在第63位之后（从零开始计数），因此子网前缀是`2001:db8:4006:80b/64`或`fd63:45eb:dc14:1/64`。这是IPv6中的正常设置：子网具有64位前缀和64位IID。
[自动地址配置](Auto-configuration.md)依赖于这个固定边界。不使用自动地址配置的链路不受/64规则的约束，但许多软件和配置依赖于它。

可路由IPv6单播地址的一个重要特征是它们分配给接口（而不是整个节点），并且每个接口可能同时具有多个地址。例如，企业网络中的主机理论上可以同时具有以下所有地址：

- 一个固定的GUA，带有DNS条目，用于充当Web服务器
- 一个带有随机IID的临时GUA，用于充当远程Web访问的客户端\[[RFC8981](https://www.rfc-editor.org/info/rfc8981)\]
- 用于企业内部事务的固定ULA
- 在不同前缀下的第二个固定GUA，带有DNS条目，用于备份

当您有一些长时间运行的TCP会话（例如ssh），并且您的系统在会话运行时创建了新地址时，您可能会看到多个带有随机IID的临时GUA地址。

然而，使最后两个设置（GUA加ULA，或两个GUA前缀）平稳工作可能具有挑战性，并在
[6. 多前缀操作](../06.%20Management%20and%20Operations/Multi-prefix%20operation.md)中讨论。

### 任播地址

在语法上，任播地址与单播地址相同，因此任何GUA或ULA都可以被视为任播。一个特殊情况是，在具有前缀P的链路上，地址P::/128（即IID设置为零）是子网路由器任播地址。这是一个示例：

```
 ----- prefix ----
 |                |
 2001:db8:4006:80b::
```

### 链路本地地址

它们看起来像：

```
prefix ------- IID -------
 |    ||                 |
 fe80::a1b3:6d7a:3f65:dd13
```

`fe80::/64`前缀足以识别链路本地地址。

链路本地地址（LLA）顾名思义：它们*永远*不会被路由器转发（但会被第2层交换机转发）。它们在地址分配的启动阶段是必不可少的，对于到达第一跳路由器也是必不可少的。

LLA特定于给定接口，具有多个第2层接口的主机在每个接口上将有不同的地址。有一个特殊的表示法，例如：

```
prefix ------- IID ------- zone
 |    ||                 | |  |
 fe80::a1b3:6d7a:3f65:dd13%eth0

or

 fe80::a1b3:6d7a:3f65:dd13%7
```

其中第一个将在例如Linux主机上看到，第二个在Windows主机上看到；'%'符号后面的字符是第2层接口的本地定义标识符。不幸的是，这在一个地址中产生了两个"标识符"。从技术上讲，根据
[RFC 4007](https://www.rfc-editor.org/info/rfc4007)，第二个可以称为"区域ID"。在某些用例中，用户界面需要接受区域ID
\[[RFC9844](https://www.rfc-editor.org/info/rfc9844)\]。不幸的是，当前的Web浏览器不支持。

### 嵌入的IPv4地址

在某些情况下，可以将IPv4地址嵌入IPv6地址中。这里我们只给出表示法——用法在
[第3章](https://github.com/becarpenter/book6/tree/main/3.%20Coexistence%20with%20legacy%20IPv4)中讨论。

IPv4映射的IPv6地址是一种将IPv4地址表示为IPv6地址的方式，例如

```
 96 bit
 prefix -- IPv4 ---
 |    | |         |
 ::ffff:192.0.2.123
```

也就是说，完整长度的前缀将是`0:0:0:0:0:ffff::/96`。

（请注意，`::ffff::/96`将是有歧义的。只允许一个'::'。）

特别是，这种形式的地址可以用来使IPv6套接字接口处理IPv4地址（参见
[RFC 4038](https://www.rfc-editor.org/info/rfc4038)）。

### 多播地址

IPv6多播地址都在`ff00::/8`前缀下，即它们以0xff开头。接下来的8位具有特殊含义，因此剩下112位来指定特定的多播组。特殊含义在
[RFC 4291](http://www.rfc-editor.org/info/rfc4291)第2.7节中有很好的解释，因此这里不再重复。一些多播地址是预定义的；例如`ff02::1`是每个IPv6节点必须侦听的链路本地"所有节点"地址，`ff02::2`是每个IPv6路由器必须侦听的链路本地"所有路由器"地址。

所有官方分配的多播地址可以在
[IANA](https://www.iana.org/assignments/ipv6-multicast-addresses/ipv6-multicast-addresses.xhtml#link-local)找到。

### Web浏览器中的文字地址

浏览器可以识别文字IPv6地址而不是主机名，但地址必须用方括号括起来，例如：

```
   https://[2001:db8:4006:80b:a1b3:6d7a:3f65:dd13]
```

当然，文字地址应该仅用于诊断或测试目的，并且通常会被复制粘贴而不是手动输入。

### 一些地址是特殊的

特殊用途的IPv6地址及其注册表在
[RFC 6890](https://www.rfc-editor.org/info/rfc6890)中描述。

您可能已经注意到上面的许多示例使用前缀`2001:db8::/32`。该前缀保留用于文档，不应出现在真实的互联网上
\[[RFC3849](https://www.rfc-editor.org/info/rfc3849)\]。对于记录需要短于/32的前缀的示例，已保留前缀`3fff::/20`\[[RFC9637](https://www.rfc-editor.org/info/rfc9637)\]。

另一个值得一提的特殊情况是_丢弃前缀_`0100::/64`；发送到此前缀中任何地址的数据包将被丢弃
\[[RFC6666](https://www.rfc-editor.org/info/rfc6666)\]。

### 过时的地址类型

- 将一些OSI地址映射到IPv6地址以及将任意OSI地址映射到IPv6目标选项的方法已被
  [RFC 4048](https://www.rfc-editor.org/info/rfc4048)废弃。

- 称为"顶级聚合器（TLA）"的格式已被
  [RFC 3587](https://www.rfc-editor.org/info/rfc3587)废弃。

- 称为"站点本地"地址的格式已被
  [RFC 3879](https://www.rfc-editor.org/info/rfc3879)废弃。

- 称为"IPv4兼容IPv6"地址的格式已被
  [RFC 4291](https://www.rfc-editor.org/info/rfc4291)废弃。

- 以前分配用于特殊用途的地址前缀在
  [单播地址注册表](https://www.iana.org/assignments/ipv6-unicast-address-assignments/ipv6-unicast-address-assignments.xhtml)中提及。

<!-- Link lines generated automatically; do not delete -->

### [<ins>上一页</ins>](Packet%20Format.md) [<ins>下一页</ins>](Layer%202%20functions.md) [<ins>顶部</ins>](02.%20IPv6%20Basic%20Technology.md)
