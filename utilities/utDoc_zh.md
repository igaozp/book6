## book6 工具

### 使用说明

所有工具都使用 Python 3 编写，应该在大多数常见操作系统上工作（但主要在 Windows 10 上测试过）。它们主要使用 `tkinter` 提供带有选项的友好用户界面。如果在命令行上以 book6 目录路径作为参数调用，它们将使用默认选项运行。例如：
```
python3 makeBook.py
```
将打开 GUI，但
```
python3 makeBook.py ~/whatever/book6
```
将直接运行。

### makeBook

每当进行重大更改时，此程序应用于整个 book6 目录。假定读者已仔细阅读[章节模板](https://github.com/becarpenter/book6/blob/main/99.%20Chapter%20Template/99.%20Chapter%20Template.md)章节。

__makeBook__ 的功能包括：

 - 更新全局目录（_Contents.md_）以反映实际的章节内容。

 - 更新各个章节文件（_./ChapterName/ChapterName.md_）以对应全局目录。

 - 创建任何缺失的小节文件（_./ChapterName/SectionName.md_）。

 - 协调全局目录、章节目录和实际小节文件之间的差异。（并非所有差异都可以自动协调 - 如果 __makeBook__ 检测到这种情况，将发出警告）。

 - 解析任何原始引用（`{{something}}` 或 `{{{something}}}`）为完整的 markdown 链接（`[something](URL)`）。

 - 创建并插入内部链接（从章节文件到各个小节，从每个小节到其前驱和后继等）。

 - 如果适当，重新格式化 markdown 文本。

更新小节后，特别是如果使用 `{{ }}` 或 `{{{ }}}` 添加新引用，应运行 __makeBook.py__（Python 3；需要 _tkinter_；如果安装了 _mdformat_ 则使用它）。

要进行除了仅更新现有小节之外的更改，还请参见 [chapterReorg](./chapterReorg.md)。

__makeBook__ 的大致工作流程如下，使用 _tkinter_ GUI，而不是标准输入。

1. 从用户请求 _book6_ 目录的名称。通常这将是 GitHub 仓库的本地副本。

2. 确定是否可以自动检查 RFC 存在性。如果 __makeBook__ 无法访问最新的 RFC 索引副本，则无法进行此检查，它会记录警告。

3. 确定是否可以自动检查 I-D 存在性。如果 __makeBook__ 无法访问当前的 I-D 索引，则无法进行此检查，它会记录警告。

4. 读入现有的主目录（_Contents.md_）。

5. 将任何纯文本章节名称转换为链接。

6. 扫描主目录并创建任何缺失的章节目录和空白章节文件，构建章节列表，提取每个章节的小节列表，并将任何缺失的小节名称添加到主目录。

7. 对于每个章节：

  * 7.1 如果主目录中的小节列表与实际存在的小节文件之间仍存在差异，记录警告，指出必须再次运行 __makeBook__ 来解决它。如果存在大小写差异（这确实需要手动修复），也会记录警告。

  * 7.2 创建并初始化任何缺失的小节文件。

  * 7.3 如果章节文件在步骤 7.1 和 7.2 期间发生任何更改，则写回。

  * 7.4 对于章节中的每个小节：

    * 7.4.1 读入 markdown 文件，如有必要更新内部链接，将任何 `{{ }}` 或 `{{{ }}}` 引用扩展为 markdown 链接（但如果失败则记录警告）。

    * 7.4.2. 如果小节文件在步骤 7.4.1 期间发生任何更改，则写回。

  * 7.5. （再次）读入章节 markdown 文件，将任何 `{{ }}` 或 `{{{ }}}` 引用扩展为 markdown 链接（但如果失败则记录警告），如有必要则写回。

8. 最后，写回主目录。

请注意，扩展引用由函数 _expand_cites()_ 完成，该函数简单直接但描述起来很繁琐。

__makeBook__ 将警告发送到标准输出，也发送到主 book6 目录中的文件 _makeBook.log_。运行后应始终检查此日志！


### indexBook

此程序应用于整个 book6 目录。它读取每个章节中的每个小节文件，如果文件 _./utilities/index6.txt_ 中的某个索引词存在，则创建或扩展索引条目，指向该小节。

索引词不区分大小写，每个词可以以多种变体出现。详细信息在 _index.txt_ 本身中给出，但例如这行
~~~
link-local 'link local' link-locals
~~~
意味着所有三个词都将在 `link-local` 下索引。

该程序还构建引用索引，显示哪些 RFC 被哪些小节索引。

最后，整理和排序的结果写入 _./Index.md_ 和 _./Citex.md`_

__indexBook__ 将警告发送到标准输出，也发送到主 book6 目录中的文件 _indexBook.log_。运行后应始终检查此日志！

### RFCbib6

此程序创建所有在标题中提到 IPv6 或来自主要 IPv6 工作组的当前 RFC 列表。不包括过时的 RFC。有标准、BCP、信息性和实验性 RFC 的小节。它通过根据上述标准处理最新的 RFC 索引副本（XML 格式）来完成此操作。结果存储为 book6 章节，位于 _./20. Further Reading/RFC bibliography.md_。

__RFCbib6__ 将警告发送到标准输出，也发送到主 book6 目录中的文件 _RFCbib6.log_。运行后应始终检查此日志！

最好之后运行 __makeBook__。（请注意，_RFC bibliography.md_ 被 __indexBook__ 忽略，以避免引用索引中的噪音。）

### bakeBook

此程序将整本书连接成一个单一的"烘焙"markdown 文件（称为 _baked.md_）。这不是为用户准备的，而是作为通往 book6 PDF 版本的中间步骤。

它的主要工作是，除了连接所有相关的 .md 文件外，修复内部引用以匹配 GitHub 为 `## Title` 格式的章节和小节标题创建锚点的方式。代码非常临时性，必须特殊处理一些细节。

在写入 _baked.md_ 后，代码尝试通过 _pandoc_ 和 _pdflatex_ 完成到 _baked.pdf_ 的转换。如果失败，手动过程在 `pdf` 目录中解释。

代码还尝试通过 _pandoc_ 转换为 _baked.epub_（电子书格式）。

标题页位于 _Title.md_，在烘焙过程中通过添加时间戳进行增强。

一个需要注意的是，所有图形文件（`.png, .jpg` 等）需要复制到主目录，并且它们的名称必须在整本书中唯一。另一个需要注意的是，小节名称也必须在整本书中唯一。

一个必要的技巧是，在需要分页的地方，通过虚拟行信号：`backslashpagebreak`。稍后将其转换为真正的分页符。

更多信息在 `pdf` 目录中。

### fixCites

这是一个一次性工具，修复 RFC 引用格式中的特定问题，以与 RFC Editor 风格指南保持一致。它应该永远不需要再次使用了....

