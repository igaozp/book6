## 多前缀运行

如[2. 地址](../02.%20IPv6%20Basic%20Technology/Addresses.md)中所述，IPv6节点可能有多个地址。一个简单的例子是一台家用PC，同时具有以太网和WiFi接口，两者都连接到同一本地网段。至少，它将有两个链路本地地址（每个接口一个）和两个GUA（全局单播地址），所有这些都由SLAAC自动分配。实际上，这种情况不会出现问题：链路本地地址不会用于外部流量，两个GUA都将在家庭网络的ISP分配的IPv6前缀下分配。特定的出站应用会话使用哪个GUA并不重要，因为对它们中的任何一个的路由都是相同的。如果PC出于隐私考虑使用临时IPv6地址\[[RFC8981](https://www.rfc-editor.org/info/rfc8981)\]，它们也将在相同的前缀下，不会出现路由问题。

类似地，具有单个IPv6前缀（通常为/48）的企业网络，由于企业主机在从该前缀派生的子网前缀下使用多个GUA，因此不会有任何路由问题。（企业可能出于其他原因，例如日志记录和审计，希望避免每个主机有多个地址；这样的企业可能会使用DHCPv6进行地址配置，而不是SLAAC。）但是，如果网络运营商希望连接到两个（或更多）不同的ISP，每个ISP提供其自己的前缀，就会出现问题。此类前缀被称为PA（提供商分配的，有时也称为提供商可聚合的），因为它们可以汇总为ISP整体的单个BGP-4路由通告。

这是一个说明性的例子。假设提供商X从其地区注册机构获得了前缀 `2001:db8:a000::/36`，提供商Y获得了 `2001:db8:b000::/36`。假设我们的企业然后从X获得了 `2001:db8:abcd::/48`，从Y获得了 `2001:db8:b123::/48`。这些前缀然后将流向企业内的子网。我们将假设特定子网已获得前缀 `2001:db8:abcd:0101::/64` 和 `2001:db8:b123:0101::/64`。因此，该子网上的主机将获得至少两个GUA，每个前缀下一个。例如，特定主机最终可能具有地址 `2001:db8:abcd:0101::abc1` 和 `2001:db8:b123:0101::def2`。

（为了使示例更易读，我们没有使用随机化的IID值。）

以下图表显示了该示例：
<img src="./multiPrefix.png" alt="如上所述的路由器和路由云">

如果出于某种原因，子网上有多个子网路由器，可以按照
[RFC 8028](https://www.rfc-editor.org/info/rfc8028)中的建议通知主机使用哪个。

要使其按预期工作，需要配置路由，以便来自 `2001:db8:abcd:0101::abc1` 的流量退出站点到ISP X，来自 `2001:db8:b123:0101::def2` 的流量退出到ISP Y。子网路由器和企业路由云的其余部分中的适当源路由规则可以实现这一点。此类源路由规则通常必须设置为路由策略，包括相关的源前缀，通过专有机制在每个路由器上配置。

但是，如果到ISP X的链路中断会发生什么？大概拥有两个ISP连接的原因正是为了备份。

我们可以在两个出口路由器之间配置低优先级（高度量）路由，这样当一个ISP链路中断时，流量将重定向到另一个。但是，如果备份ISP应用入口过滤\[[BCP84](https://www.rfc-editor.org/info/bcp84)\]，这可能会失败，因此企业需要安排其ISP接受相互备份流量。

如果不采取这些步骤（源路由*和*备份路由*和*过滤例外），两个ISP连接之一的故障将导致使用该ISP的PA前缀下的地址的所有用户会话失败。

即使有备份路由，如果在企业*内部*发起的用户客户端会话使用失败的PA前缀下的IPv6源地址，也可能会出现问题。这将发生，除非主机以某种方式被导致弃用此类源地址，以便
[RFC 6724](https://www.rfc-editor.org/info/rfc6724)的算法不会选择它们。

建议的另一种技术是站点部署_条件性_路由器通告
\[[RFC8475](https://www.rfc-editor.org/info/rfc8475)\]。

整个主题在
[RFC 8678](https://www.rfc-editor.org/info/rfc8678)中进行了更深入的讨论。

对复杂配置的需求和由此产生的故障模式解释了为什么许多企业没有选择基于PA的多前缀多宿主。相反，他们付费从互联网注册机构获得提供商独立（PI）的IPv6前缀，通常长度为/48。然而，从长远来看，这预计会有问题，因为每个这样的企业都会增加互联网范围的BGP-4路由表的大小。这对于几千家企业可能是可行的，但对于数百万家企业来说不可行，即对于可能受益于多宿主的小型企业甚至家庭办公室来说不可行。

在撰写本文时，多提供商IPv6服务多宿主（称为MHMP）的最实用解决方案仍在IETF中讨论。

多前缀的另一个用例是企业（或家庭），除了其PA或PI前缀（可在互联网上的任何地方路由）外，还决定使用唯一本地地址（ULA）前缀进行严格的内部通信。尽管大多数运营商不熟悉这一点，但这在概念上很简单，并创建了一类*根据定义*无法逃离站点的流量，这具有明显的隐私和安全吸引力。应该只能在内部访问的服务可以配置为*仅*使用ULA，这些地址可以输入到本地分割视野DNS中（
\[[RFC6950](https://www.rfc-editor.org/info/rfc6950)\]第4节）。在撰写本文时，这种情况下存在一个运维问题：使用
[RFC 6724](https://www.rfc-editor.org/info/rfc6724)默认设置配置的主机计算机不会优先选择ULA而不是IPv4地址
\[[draft-ietf-v6ops-ula](https://datatracker.ietf.org/doc/draft-ietf-v6ops-ula/)\]。
使用DHCPv6的站点可以通过
[RFC 7078](https://www.rfc-editor.org/info/rfc7078)更改默认设置，但遗憾的是这并未广泛实施。

解决此问题的部分方法是主机在DNS中有两个AAAA记录，例如 `www.example.com` 用于其GUA，`w3.example.com` 用于其ULA，后者仅存在于本地分割视野DNS中。

<!-- Link lines generated automatically; do not delete -->

### [<ins>上一页</ins>](Security%20operation.md) [<ins>下一页</ins>](Multihoming.md) [<ins>返回顶部</ins>](06.%20Management%20and%20Operations.md)
