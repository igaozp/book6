## 多宿主

多宿主意味着以这样一种方式配置站点，即通过多个链路连接到互联网，最好是通过不同的ISP，通常是为了在发生故障时提供冗余。"多提供商多宿主"（MHMP）这一短语有时会被使用。
[<ins>上一节</ins>](Multi-prefix%20operation.md)描述了使用多个地址前缀实现MHMP的问题。本节讨论站点多宿主的实用技术。

家庭或非常小的办公室安装不在本主题的范围内。它们很少永久连接到多个ISP，因此无法期望平滑的故障转移。它们可能有备用连接（例如，无线热点而不是陆地连接），但切换将相当于网络重启，并且可能需要手动操作。

请注意，术语"多宿主"有时用于描述站点网络_内部_的配置，其中节点连接到多个内部路由器以提供冗余。这会使站点路由复杂化，不是这里的主题。

2003年，IETF为站点多宿主制定了目标
\[[RFC3582](https://www.rfc-editor.org/info/rfc3582)\]。总之，主要目标是：冗余、负载共享、性能、策略控制、简单性和传输会话可存活性。在不描述此后所做的所有努力的情况下，很明显，同时满足所有这些目标的解决方案很难找到。最近的概述可以在
[RFC 7157](https://www.rfc-editor.org/info/rfc7157)中找到。

### 大型站点

今天，对于大型站点，或分布在多个物理站点上的大型企业网络，最实用的方法是从适当的互联网地址注册机构获得提供商独立（PI）前缀，这通常是/48前缀，例如
`2001:db8:face::/48`。然后，企业网络中需要互联网访问的所有主机都将在该前缀内分配IPv6地址。它们也可能被分配唯一本地地址（ULA）用于内部使用，或IPv4地址，或两者都有。然后，企业将选择至少两个ISP来提供到互联网的冗余连接，并安排它们都通告到该前缀的BGP-4路由。

/48前缀提供了超过65,000个子网的理论容量。但是，如果提供充分的技术理由，极大型企业可以从地址注册机构之一获得短于/48的前缀。

必须根据需要安排内部路由以引导流量，使用有利于一个或另一个ISP的路由度量，或者根据需要分散负载。当到特定ISP的出口失败时，到备用出口路由器的备份路由将接管。企业的另一个优势是永远不需要地址重新编号，因为/48前缀与企业绑定，而不是与其ISP之一绑定。

这种方法经过了尝试和测试。但是，有两个原因使其无法无限期地扩展到覆盖较小的企业甚至家庭用户。首先，它的成本明显高于单个提供商分配的（PA）前缀，并且需要熟练技术人员进行一定程度的运维管理。其次，广域BGP-4路由系统被广泛认为无法应对数百万个PI前缀，如果大多数中小型企业采用此解决方案，就会产生这样的前缀。2023年11月，全球BGP-4系统承载约200,000条IPv6路由。估计仅美国就有3200万家小企业，全球有2亿家。如果每个小企业突然都有自己的PI前缀，互联网将停止工作。

### 中小型站点

除了数千家大型企业外，中小型企业的多宿主可行解决方案必须基于PA地址，如果要被数百万个站点使用的话。但是，如[<ins>上一节</ins>](Multi-prefix%20operation.md)所示，同时使用多个PA前缀目前是不切实际的，特别是如果需要传输会话可存活性的话。

IETF已经做出了各种尝试来解决这个问题，包括SHIM6协议\[[RFC5533](https://www.rfc-editor.org/info/rfc5533)\]和多配置域架构
\[[RFC7556](https://www.rfc-editor.org/info/rfc7556)\]。这些方法尚未成功部署。其他选项，例如在单个站点集中大型企业网络的冗余连接，或部署应用层代理以解耦内部和外部寻址，对于中小型企业来说仍然遥不可及。

如果我们放弃传输会话可存活性的目标，使得应用程序必须在多宿主故障转移后从断开的传输连接中恢复，问题就简化了。应该注意的是，基本上所有大众市场客户端应用程序都已经处理了这种断开连接，当移动或便携式设备从一个地方移动到另一个地方时，这种断开连接很常见。这导致了小型站点多宿主的一种可能方法，即基本上不做任何事情，只是将站点连接到两个（或更多）ISP并分配两个（或更多）PA前缀，让客户端应用程序通过试错来找到工作路径。这本质上是Happy Eyeballs方法\[[RFC8305](https://www.rfc-editor.org/info/rfc8305)\]的推广，但对于不够有弹性的应用程序，这将导致帮助台电话。它显然不足以用于大型站点，特别是如果它运行服务器和客户端主机的话。

一种应该避免其中一些帮助台电话的方法，但目前IETF不赞成，是使用动态网络前缀转换，称为NPTv6
\[[RFC6296](https://www.rfc-editor.org/info/rfc6296)\]，
\[[3. 转换和IPv4即服务](../03.%20Coexistence%20with%20Legacy%20IPv4/Translation%20and%20IPv4%20as%20a%20service.md)\]。
在此模型中，转换器放置在站点出口路由器上，朝向每个ISP。出站和入站数据包被转换为适当的PA地址。每个地址的可路由前缀部分被更改，可能还有IID中的一些位，以避免传输校验和错误的方式。这种转换是无状态且可逆的，因此比传统NAT造成的困难要少得多；不需要端口转换。

为了简化转换过程，内部主机（客户端和服务器）将被分配唯一本地地址（ULA）
\[[RFC4193](https://www.rfc-editor.org/info/rfc4193)\]，这些地址很少会改变。但是，服务器将通过DNS使用其转换后的PA地址向外部世界宣布。

已知此方法已成功测试，尽管IETF不推荐。但是，应该注意的是，NPTv6并不共享IPv4 NAT的所有缺点。如RFC 6296中所讨论的，

- NPTv6不需要转换端口号，并且它是校验和中性的，因此传输层实际上不受影响。

- 转换是无状态的，因此诸如非对称路由、负载共享和路由器故障转移之类的事情不受影响。

- 过滤不需要的流量需要足够的防火墙，但对于任何严肃的IPv6（或IPv4）部署都是如此。

- 拓扑隐藏，有时被引用为NAT的论据，在
  \[[4. 拓扑混淆](../04.%20Security/Topology%20obfuscation.md)\]中讨论。
  NPTv6确实在很大程度上混淆了本地拓扑。例如（同样遵循RFC 6296），实际地址为
  `fd01:0203:0405:0001::1234` 的主机可能在互联网上显示为
  `2001:db8:0001:d550::1234`。不知道站点的ULA前缀（`fd01:0203:0405::/48`）的攻击者无法反向转换并推断实际的子网前缀。

当然，NPTv6保留了NAT的一些缺点：所有直接源于连接两端具有不同IP地址的问题。
[RFC 6296](https://www.rfc-editor.org/info/rfc6296)的第5节讨论了这一点。任何运行NPTv6的站点都必须处理这些问题，或避免任何受影响的应用程序。特别是，SIP（IP电话的会话发起协议）在没有代理机制
\[[RFC6314](https://www.rfc-editor.org/info/rfc6314)\]的支持以及IPv6/IPv4共存的规定
\[[RFC6157](https://www.rfc-editor.org/info/rfc6157)\]的情况下将无法工作。这限制了NPTv6的适用性。

### 传输层解决方案

站点多宿主的另一种可能方法是将其视为传输层问题。如果传输协议足够敏捷以使用多个路径（即多个源/目标地址对），则可以隐藏网络层的故障。多路径TCP（MPTCP，
\[[RFC8684](https://www.rfc-editor.org/info/rfc8684)\]）已定义但尚未广泛使用。QUIC的多路径版本正在讨论中，还有一个支持多路径解决方案的传输层的通用API。IETF中的讨论仍在继续。

<!-- Link lines generated automatically; do not delete -->

### [<ins>上一页</ins>](Multi-prefix%20operation.md) [<ins>下一页</ins>](Energy%20consumption.md) [<ins>返回顶部</ins>](06.%20Management%20and%20Operations.md)
